<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Calculadora de Inversión</title>

<link rel="apple-touch-icon" href="./apple-touch-icon.png">
<link rel="icon" href="./icon-192.png" sizes="192x192">
<link rel="manifest" href="./manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
:root{--bg:#0b1324;--card:#121a2f;--text:#e8eefc;--muted:#9db0d6;--accent:#4d7cff}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
.wrap{max-width:1000px;margin:12px auto;padding:0 10px}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{font-size:20px;margin:0 0 6px}.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,select{background:#0e1730;border:1px solid #223153;border-radius:10px;padding:12px;color:var(--text);font-size:16px}
input[type="number"]{width:140px}input[type="text"]{flex:1 1 220px}
button{appearance:none;border:none;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer;font-size:16px}
.primary{background:var(--accent);color:#fff}.ghost{background:#1a2544;color:var(--text)}.danger{background:#ff6b6b;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}th,td{padding:8px 10px;border-bottom:1px solid #243355;font-size:14px}
th{color:#9db0d6;text-align:left}.right{text-align:right}.tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.income{background:#183f2e;color:#9ff3c7}.cost{background:#402424;color:#f7a4a4}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.kpi .box{background:#0e1730;border:1px solid #223153;border-radius:10px;padding:10px 12px;min-width:160px}
.ok{color:#8ef6b1}.warn{color:#ffd166}.bad{color:#ff9aa2}
.canvasWrap{width:100%;height:320px;background:#0e1730;border:1px solid #223153;border-radius:10px;margin-top:8px}
canvas{width:100%;height:100%;display:block}
@media (max-width:480px){input,select,button{font-size:16px;padding:12px}h1{font-size:18px}}
</style>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
}
</script>
</head>
<body>
<div class="wrap"><div class="card">
<h1>Calculadora de inversión</h1>
<p class="muted">Añade ingresos/costes por rango (meses desde t=0). En costes puedes indicar interés anual (%). Calcula ROI, TIR y Multiplicador. Genera PDF.</p>

<div class="row" style="margin-top:6px">
  <select id="tipo"><option value="income">Ingreso</option><option value="cost">Coste</option></select>
  <input id="concepto" type="text" placeholder="Concepto">
  <input id="start" type="number" min="0" step="1" placeholder="Inicio m">
  <input id="dur" type="number" min="1" step="1" placeholder="Duración">
  <input id="importe" type="number" step="0.01" inputmode="decimal" placeholder="€ / mes">
  <input id="interes" type="number" step="0.01" inputmode="decimal" placeholder="% anual (costes)">
  <button class="ghost" id="btnAdd">Agregar</button>
  <button class="primary" id="btnCalc">Calcular rentabilidad</button>
</div>

<table id="tabla"><thead><tr>
  <th>Tipo</th><th>Concepto</th><th>Inicio</th><th>Duración</th><th class="right">€ / mes</th><th class="right">% anual</th><th class="right">Acciones</th>
</tr></thead><tbody></tbody>
<tfoot><tr><th colspan="7" class="muted">Costes con interés: €/mes × (1+r/12)^m dentro del rango.</th></tr></tfoot></table>

<div class="kpi" id="kpis" style="display:none">
  <div class="box"><div class="muted">ROI</div><div id="roi" style="font-size:18px">—</div></div>
  <div class="box"><div class="muted">TIR (anual)</div><div id="irr" style="font-size:18px">—</div></div>
  <div class="box"><div class="muted">Multiplicador</div><div id="mult" style="font-size:18px">—</div></div>
  <div class="box"><div class="muted">Rating</div><div id="rating" style="font-size:18px">—</div></div>
</div>

<div class="canvasWrap"><canvas id="chart"></canvas></div>
<div class="row" style="justify-content:flex-end;margin-top:10px">
  <button class="danger" id="btnReset">Reiniciar</button>
  <button class="primary" id="btnPDF">Generar PDF</button>
</div>

</div></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
// ===== Retina canvas =====
(function resizeCanvas(){
  const c=document.getElementById('chart'); const dpr=window.devicePixelRatio||1;
  function fit(){ const r=c.getBoundingClientRect(); c.width=Math.round(r.width*dpr); c.height=Math.round(r.height*dpr); if (window.lastCF) drawChart(window.lastCF); }
  window.addEventListener('load',fit); window.addEventListener('resize',fit);
})();

// ===== Estado y utilidades =====
const items=[]; const tbody=document.querySelector('#tabla tbody');
const fmt=n=>(isFinite(n)?n:0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
const pct=n=>(isFinite(n)?(n*100):0).toLocaleString('es-ES',{minimumFractionDigits:1,maximumFractionDigits:1})+' %';
function escapeHTML(s){return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

// Alta
document.getElementById('btnAdd').onclick=()=>{
  const tipo=document.getElementById('tipo').value;
  const concepto=document.getElementById('concepto').value.trim()||(tipo==='income'?'Ingreso':'Coste');
  const start=+document.getElementById('start').value;
  const dur=+document.getElementById('dur').value;
  const importe=+document.getElementById('importe').value;
  const interes=+document.getElementById('interes').value||0;
  if(!Number.isInteger(start)||start<0) return alert('Inicio ≥ 0');
  if(!Number.isInteger(dur)||dur<1) return alert('Duración ≥ 1');
  if(!isFinite(importe)||importe===0) return alert('€ / mes ≠ 0');
  if(tipo==='cost' && interes<0) return alert('Interés anual no puede ser negativo');
  items.push({id:crypto.randomUUID(),tipo,concepto,start,dur,importe,interes:tipo==='cost'?interes:0});
  renderTable();
  ['concepto','importe','interes'].forEach(id=>document.getElementById(id).value='');
};

function renderTable(){
  tbody.innerHTML='';
  for(const it of items){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="tag ${it.tipo==='income'?'income':'cost'}">${it.tipo==='income'?'Ingreso':'Coste'}</span></td>
      <td>${escapeHTML(it.concepto)}</td><td>${it.start}</td><td>${it.dur}</td>
      <td class="right">${fmt(it.importe)}</td>
      <td class="right">${it.tipo==='cost'? (it.interes.toFixed(2)+' %'):'—'}</td>
      <td class="right"><button class="ghost" data-del="${it.id}">Eliminar</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>{
    const id=b.getAttribute('data-del'); const i=items.findIndex(x=>x.id===id);
    if(i>=0) items.splice(i,1); renderTable();
  });
}

// Cashflow mensual
function buildCashflow(){
  if(!items.length) return [];
  const last=Math.max(...items.map(it=>it.start+it.dur-1));
  const cf=new Array(last+1).fill(0);
  for(const it of items){
    const r_m=(it.interes||0)/100/12;
    for(let m=0;m<it.dur;m++){
      const idx=it.start+m;
      if(it.tipo==='income'){ cf[idx]+=Math.abs(it.importe); }
      else { const factor=Math.pow(1+r_m,m); cf[idx]-=Math.abs(it.importe)*factor; }
    }
  }
  return cf;
}

// KPIs
function computeKPIs(cf){
  const inflows=cf.filter(x=>x>0).reduce((a,b)=>a+b,0);
  const outflowsAbs=-cf.filter(x=>x<0).reduce((a,b)=>a+b,0);
  const roi=outflowsAbs>0?(inflows-outflowsAbs)/outflowsAbs:(inflows>0?Infinity:0);
  const mult=outflowsAbs>0?inflows/outflowsAbs:(inflows>0?Infinity:1);
  const r_m=irrMonthly(cf); const irr_annual=(r_m!=null)?(Math.pow(1+r_m,12)-1):null;
  return {roi,mult,irr_annual};
}
function npv(cf,r){let s=0;for(let t=0;t<cf.length;t++) s+=cf[t]/Math.pow(1+r,t);return s;}
function irrMonthly(cf){
  if(!cf.length) return null; const hasPos=cf.some(x=>x>0), hasNeg=cf.some(x=>x<0); if(!hasPos||!hasNeg) return null;
  let lo=-0.9999, hi=10, f_lo=npv(cf,lo), f_hi=npv(cf,hi);
  if(f_lo*f_hi>0){ for(let k=0;k<10&&f_lo*f_hi>0;k++){hi*=2;f_hi=npv(cf,hi);} if(f_lo*f_hi>0) return null; }
  for(let i=0;i<200;i++){ const mid=(lo+hi)/2, f=npv(cf,mid); if(Math.abs(f)<1e-6) return mid; if(f*f_lo<0){hi=mid;f_hi=f;} else {lo=mid;f_lo=f;} }
  return (lo+hi)/2;
}
function ratingFor(k){
  const irr=k.irr_annual, roi=k.roi, mult=k.mult;
  if(irr!=null && irr>=0.15 && roi>=0.30 && mult>=1.5) return {label:'Excelente',cls:'ok'};
  if(irr!=null && irr>=0.10 && roi>=0.20 && mult>=1.2) return {label:'Buena',cls:'warn'};
  return {label:'Mejorable',cls:'bad'};
}

// Gráfica (negativos arriba, positivos abajo)
function drawChart(cf){
  const c=document.getElementById('chart'), ctx=c.getContext('2d'), w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);
  const pad={l:50,r:20,t:20,b:30}, X0=pad.l, X1=w-pad.r, Y0=h-pad.b, Y1=pad.t;
  if(!cf.length){ ctx.fillStyle='#9db0d6'; ctx.font=`${12*(window.devicePixelRatio||1)}px system-ui`; ctx.fillText('Añade ítems y pulsa “Calcular rentabilidad”.', 20*(window.devicePixelRatio||1), 32*(window.devicePixelRatio||1)); return; }
  const n=cf.length, minV=Math.min(0,...cf), maxV=Math.max(0,...cf), absMax=Math.max(Math.abs(minV),Math.abs(maxV),1);
  const y0=(h-pad.b+pad.t)/2;
  ctx.strokeStyle='#2c3b63'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(X0,y0); ctx.lineTo(X1,y0); ctx.stroke();
  const bar=Math.max(2,(X1-X0)/n*0.7);
  for(let i=0;i<n;i++){
    const xi=X0 + i*(X1-X0)/n + ((X1-X0)/n - bar)/2;
    const v=cf[i];
    const yy = y0 + (v/absMax)*((Y0-Y1)/2);
    ctx.fillStyle = v>=0 ? '#3de1a9' : '#ff7b7b';
    if(v>=0){ ctx.fillRect(xi, y0, bar, yy - y0); } else { ctx.fillRect(xi, yy, bar, y0 - yy); }
  }
  ctx.fillStyle='#9db0d6'; ctx.font=`${11*(window.devicePixelRatio||1)}px system-ui`;
  const ticks=Math.min(12,n-1); for(let i=0;i<=ticks;i++){ const t=Math.round(i*(n-1)/ticks); const x=X0 + t*(X1-X0)/n + ((X1-X0)/n)/2; ctx.fillText('m'+t, x-10, h-8); }
  for(let i=1;i<=2;i++){ const val=i*absMax/2; ctx.fillText(fmt(val), 6, y0 + (val/absMax)*((Y0-Y1)/2) + 4); ctx.fillText('-'+fmt(val), 6, y0 - (val/absMax)*((Y0-Y1)/2) + 4); }
}

// Calcular
let lastCF=null, lastKPIs=null;
document.getElementById('btnCalc').onclick=()=>{
  const cf=buildCashflow(); lastCF=window.lastCF=cf; drawChart(cf);
  const k=computeKPIs(cf); lastKPIs=k;
  document.getElementById('kpis').style.display='flex';
  document.getElementById('roi').textContent=isFinite(k.roi)?pct(k.roi):'∞';
  document.getElementById('irr').textContent=(k.irr_annual==null)?'—':pct(k.irr_annual);
  document.getElementById('mult').textContent=isFinite(k.mult)?k.mult.toFixed(2):'∞';
  const rate=ratingFor(k); const ratingEl=document.getElementById('rating'); ratingEl.textContent=rate.label; ratingEl.className=rate.cls;
};

// PDF
document.getElementById('btnPDF').onclick=()=>{
  if(!lastCF) return alert('Primero calcula la rentabilidad.');
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}); const pad=40; let y=pad;
  function line(txt,size=12,bold=false){ doc.setFont('helvetica',bold?'bold':'normal'); doc.setFontSize(size); const lines=doc.splitTextToSize(txt,515); doc.text(lines,pad,y); y+=lines.length*(size+4); }
  line('Informe de Inversión',18,true); line(`Fecha: ${new Date().toLocaleString('es-ES')}`);
  line('Entradas',14,true); if(!items.length) line('—'); else items.forEach(it=> line(`• ${it.tipo==='income'?'Ingreso':'Coste'} — ${it.concepto} | inicio m${it.start} | dur ${it.dur} | €/${'mes'} ${fmt(it.importe)}${it.tipo==='cost'?` | interés ${it.interes.toFixed(2)} %`:''}`));
  line('KPIs',14,true); const rate=ratingFor(lastKPIs);
  line(`ROI: ${isFinite(lastKPIs.roi)?pct(lastKPIs.roi):'∞'}`); line(`TIR (anual): ${lastKPIs.irr_annual==null?'—':pct(lastKPIs.irr_annual)}`); line(`Multiplicador: ${isFinite(lastKPIs.mult)?lastKPIs.mult.toFixed(2):'∞'}`); line(`Rating: ${rate.label}`);
  line('Notas',14,true); line('• Costes con interés compuesto mensual: € × (1 + r/12)^m.'); line('• TIR anualizada desde TIR mensual: (1+r_m)^12 - 1.'); line('• Cálculos orientativos.');
  doc.save(`Informe_Inversion_${Date.now()}.pdf`);
};

// Reset
document.getElementById('btnReset').onclick=()=>{
  items.splice(0); renderTable(); lastCF=null; lastKPIs=null;
  const c=document.getElementById('chart'),ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  document.getElementById('kpis').style.display='none';
};
</script>
</body>
</html>
